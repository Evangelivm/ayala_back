#==============================================================================
# CONFIGURACIÓN DE APACHE FLINK PARA SISTEMA AYALA
#==============================================================================
# Archivo: flink-conf.yaml
# Propósito: Configuración principal del cluster Flink
# Última actualización: 2026-01-31
#==============================================================================

#------------------------------------------------------------------------------
# CONFIGURACIÓN DEL JOBMANAGER
#------------------------------------------------------------------------------
jobmanager.rpc.address: flink-jobmanager
jobmanager.rpc.port: 6123
jobmanager.bind-host: 0.0.0.0
jobmanager.memory.process.size: 2048m
jobmanager.memory.jvm-overhead.max: 512m

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE TASKMANAGERS
#------------------------------------------------------------------------------
taskmanager.bind-host: 0.0.0.0
taskmanager.host: localhost
taskmanager.numberOfTaskSlots: 4
taskmanager.memory.process.size: 4096m
taskmanager.memory.managed.fraction: 0.4
taskmanager.memory.network.fraction: 0.1

#------------------------------------------------------------------------------
# PARALELISMO
#------------------------------------------------------------------------------
parallelism.default: 4
taskmanager.memory.task.heap.size: 2048m

#------------------------------------------------------------------------------
# STATE BACKEND - ROCKSDB (PRODUCCIÓN)
#------------------------------------------------------------------------------
# Tipo de backend: rocksdb para producción, hashmap para desarrollo
state.backend: rocksdb

# Directorio para checkpoints (persistencia)
state.checkpoints.dir: file:///opt/flink/checkpoints

# Directorio para savepoints (backups manuales)
state.savepoints.dir: file:///opt/flink/checkpoints/savepoints

# Checkpoints incrementales (más eficiente)
state.backend.incremental: true

# Configuración de RocksDB
state.backend.rocksdb.checkpoint.transfer.thread.num: 4
state.backend.rocksdb.localdir: /opt/flink/data/rocksdb
state.backend.rocksdb.predefined-options: FLASH_SSD_OPTIMIZED
state.backend.rocksdb.timer-service.factory: ROCKSDB

#------------------------------------------------------------------------------
# CHECKPOINTING (Recuperación ante fallos)
#------------------------------------------------------------------------------
# Intervalo de checkpoints (cada 60 segundos)
execution.checkpointing.interval: 60000

# Modo: exactly-once garantiza que cada registro se procesa exactamente una vez
execution.checkpointing.mode: EXACTLY_ONCE

# Timeout de checkpoint (5 minutos)
execution.checkpointing.timeout: 300000

# Mínimo tiempo entre checkpoints (30 segundos)
execution.checkpointing.min-pause: 30000

# Checkpoints concurrentes máximos
execution.checkpointing.max-concurrent-checkpoints: 1

# Mantener checkpoints después de cancelar job
execution.checkpointing.externalized-checkpoint-retention: RETAIN_ON_CANCELLATION

# Tolerancia a fallos de checkpoint
execution.checkpointing.tolerable-failed-checkpoints: 3

#------------------------------------------------------------------------------
# RESTART STRATEGY (Estrategia de reintentos)
#------------------------------------------------------------------------------
# Estrategia: reintentar con delay exponencial
restart-strategy: exponential-delay

# Intentos iniciales de backoff
restart-strategy.exponential-delay.initial-backoff: 1s

# Backoff máximo
restart-strategy.exponential-delay.max-backoff: 5min

# Multiplicador de backoff
restart-strategy.exponential-delay.backoff-multiplier: 2.0

# Reintentos antes de fallar
restart-strategy.exponential-delay.attempts-before-reset-backoff: 10

#------------------------------------------------------------------------------
# WEB UI
#------------------------------------------------------------------------------
rest.port: 8081
rest.address: 0.0.0.0
rest.bind-address: 0.0.0.0

#------------------------------------------------------------------------------
# HISTORIAL Y ARCHIVOS
#------------------------------------------------------------------------------
jobmanager.archive.fs.dir: file:///opt/flink/data/archive
historyserver.web.address: 0.0.0.0
historyserver.web.port: 8082
historyserver.archive.fs.dir: file:///opt/flink/data/archive
historyserver.archive.fs.refresh-interval: 10000

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE RED
#------------------------------------------------------------------------------
taskmanager.network.memory.fraction: 0.1
taskmanager.network.memory.min: 64mb
taskmanager.network.memory.max: 1gb

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE SLOTS
#------------------------------------------------------------------------------
# Compartir slots entre operadores (más eficiente)
cluster.evenly-spread-out-slots: true

#------------------------------------------------------------------------------
# TIMEOUTS
#------------------------------------------------------------------------------
akka.ask.timeout: 60s
web.timeout: 300000

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
# Nivel de log
# Opciones: TRACE, DEBUG, INFO, WARN, ERROR
env.log.level: INFO

#------------------------------------------------------------------------------
# MÉTRICAS Y MONITOREO
#------------------------------------------------------------------------------
metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
metrics.reporter.prom.port: 9249

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE TABLAS (Flink SQL)
#------------------------------------------------------------------------------
table.exec.resource.default-parallelism: 4
table.optimizer.join-reorder-enabled: true

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE KAFKA (si se usa Kafka connector)
#------------------------------------------------------------------------------
# Kafka consumer commit offsets cada 5 segundos
kafka.consumer.commit.interval.ms: 5000

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE FILESYSTEM
#------------------------------------------------------------------------------
fs.default-scheme: file:///

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE CLASSLOADER
#------------------------------------------------------------------------------
classloader.resolve-order: child-first
classloader.check-leaked-classloader: true

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE ALTA DISPONIBILIDAD (HA) - DESHABILITADO
#------------------------------------------------------------------------------
# Para habilitar HA en producción, descomentar y configurar:
# high-availability: zookeeper
# high-availability.storageDir: file:///opt/flink/ha
# high-availability.zookeeper.quorum: zookeeper:2181
# high-availability.zookeeper.path.root: /flink
# high-availability.cluster-id: /ayala-cluster

#------------------------------------------------------------------------------
# SECURITY - DESHABILITADO (habilitar en producción si es necesario)
#------------------------------------------------------------------------------
# security.ssl.enabled: false
# security.kerberos.login.use-ticket-cache: false

#------------------------------------------------------------------------------
# CONFIGURACIÓN DE RECURSOS
#------------------------------------------------------------------------------
# Modo de deployment: standalone (para Docker)
# Opciones: standalone, kubernetes, yarn
execution.target: standalone

#==============================================================================
# NOTAS DE CONFIGURACIÓN
#==============================================================================
#
# ROCKSDB STATE BACKEND:
# - Almacena estado en disco (RocksDB) con cache en memoria
# - Soporta estados muy grandes (GB/TB)
# - Ideal para producción con ventanas largas
# - Checkpoints incrementales ahorran tiempo y espacio
#
# CHECKPOINTING:
# - Cada 60s se guarda snapshot del estado
# - Si Flink se cae, recupera desde último checkpoint
# - exactly-once garantiza no perder ni duplicar eventos
#
# RESTART STRATEGY:
# - Si un job falla, reintenta automáticamente
# - Backoff exponencial: 1s, 2s, 4s, 8s... hasta 5min
# - Después de 10 intentos, resetea el backoff
#
# RECURSOS:
# - JobManager: 2GB RAM (coordinación)
# - TaskManager: 4GB RAM cada uno (procesamiento)
# - RocksDB usa disco, pero cachea en RAM
#
# PARA DESARROLLO:
# - Reducir execution.checkpointing.interval a 10000 (10s)
# - Cambiar env.log.level a DEBUG
# - state.backend a hashmap si no necesitas persistencia
#
# PARA PRODUCCIÓN:
# - Habilitar HA con ZooKeeper
# - Configurar múltiples JobManagers
# - Habilitar SSL/TLS
# - Configurar autenticación
#
#==============================================================================
